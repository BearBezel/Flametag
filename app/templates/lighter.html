{% extends "base.html" %}
{% block content %}

<div class="page">

  <div class="page-header">
    <h1 class="page-title">FlameTag</h1>
    <p class="page-subtitle">
      Lighter ID: <span class="code">{{ lighter.token }}</span> · Scans: {{ lighter.scan_count }}
    </p>
  </div>

  {% if lighter.is_claimed() %}

    <!-- Public message -->
    <div class="panel">
      <div class="section-title">Public message</div>
      <div class="big-message">{{ lighter.public_message }}</div>
    </div>

    <!-- Owner private message (only when unlocked) -->
    {% if show_private %}
      <div class="panel" style="margin-top:14px;">
        <div class="section-title">Owner private message</div>
        <div class="big-message">{{ lighter.private_message }}</div>
      </div>
    {% endif %}

    <!-- Found note (owner can see this once claimed) -->
    {% if lighter.found_note %}
      <div class="panel" style="margin-top:14px;">
        <div class="section-title">Found note</div>
        <div class="big-message">{{ lighter.found_note }}</div>
        {% if lighter.found_at %}
          <div class="small-note" style="margin-top:10px;">
            Received: {{ lighter.found_at }}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- Actions -->
    <div class="panel">
      <div class="section-title">Actions</div>

      <div class="tab-row">
        <button class="tab-btn active" type="button" data-tab="unlock">Unlock</button>
        <button class="tab-btn" type="button" data-tab="edit">Owner edit</button>
        <button class="tab-btn" type="button" data-tab="found">Found it?</button>
      </div>

      <!-- TAB: Unlock -->
      <div class="tab-panel" id="tab-unlock">
        <form method="post" action="{{ url_for('main.unlock_private', token=lighter.token) }}" class="stack">
          <label>PIN</label>
          <input name="pin" placeholder="Enter PIN" />
          <button class="btn primary" type="submit">Unlock private message</button>
          <div class="small-note">Only the owner PIN can unlock the private message.</div>
        </form>
      </div>

      <!-- TAB: Owner edit -->
      <div class="tab-panel hidden" id="tab-edit">
        <form method="post" action="{{ url_for('main.edit_lighter', token=lighter.token) }}" class="stack">
          <label>Owner PIN</label>
          <input name="pin" placeholder="Owner PIN" />

          <label>Public message</label>
          <textarea name="public_message">{{ lighter.public_message }}</textarea>

          <label>Private message</label>
          <textarea name="private_message">{{ lighter.private_message }}</textarea>

          <button class="btn primary" type="submit">Save changes</button>
        </form>
      </div>

      <!-- TAB: Found it -->
      <div class="tab-panel hidden" id="tab-found">
        <form method="post" action="{{ url_for('main.found_lighter', token=lighter.token) }}" class="stack">
          <label>Your note to the owner</label>
          <textarea name="found_note" required placeholder="Found at Shoreditch station. Contact me on…"></textarea>
          <button class="btn secondary" type="submit">Send note</button>
          <div class="small-note">Your note is saved for the owner to see.</div>
        </form>
      </div>

    </div>

  {% else %}

    <!-- Not claimed yet -->
    <div class="panel">
      <div class="section-title">Tag this lighter</div>
      <p class="page-subtitle">
        Set your public + private message and a PIN.
      </p>

      <form method="post" action="{{ url_for('main.claim_lighter', token=lighter.token) }}" class="stack">
        <label>Public message</label>
        <textarea name="public_message"></textarea>

        <label>Private message</label>
        <textarea name="private_message"></textarea>

        <label>Choose a PIN (min 4 chars)</label>
        <input name="pin" />

        <button class="btn primary" type="submit">Tag it</button>
      </form>
    </div>

  {% endif %}

</div>

<script>
  const btns = document.querySelectorAll(".tab-btn");
  const panels = {
    unlock: document.getElementById("tab-unlock"),
    edit: document.getElementById("tab-edit"),
    found: document.getElementById("tab-found"),
  };

  btns.forEach((b) => {
    b.addEventListener("click", () => {
      btns.forEach((x) => x.classList.remove("active"));
      b.classList.add("active");

      Object.values(panels).forEach((p) => p.classList.add("hidden"));
      panels[b.dataset.tab].classList.remove("hidden");
    });
  });
</script>

{% endblock %}
